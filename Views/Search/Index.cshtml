@model Home_furnishings.ViewModels.SearchViewModel
@{
    ViewData["Title"] = !string.IsNullOrEmpty(Model.Query) ? $"Search Results for '{Model.Query}'" : "Search Products";
    Layout = "_MyLayout";
}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-lg-3 col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Products</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Index" method="get" id="searchForm">
                        <!-- Search Query -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Search</label>
                            <input type="text" name="query" class="form-control" placeholder="Search products..." 
                                   value="@Model.Query" id="searchInput" autocomplete="off">
                            <div id="searchSuggestions" class="search-suggestions"></div>
                        </div>

                        <!-- Category Filter -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Category</label>
                            <select name="categoryId" class="form-select">
                                <option value="">All Categories</option>
                                @foreach (var category in Model.Categories)
                                {
                                        <option value="@category.CategoryId" selected="@(Model.CategoryId == category.CategoryId)">
                                        @category.Name (@category.ProductCount)
                                        </option>
                                }
                            </select>
                        </div>

                        <!-- Price Range -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Price Range</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" name="minPrice" class="form-control form-control-sm" 
                                           placeholder="Min $" value="@Model.MinPrice" step="0.01" min="0">
                                </div>
                                <div class="col-6">
                                    <input type="number" name="maxPrice" class="form-control form-control-sm" 
                                           placeholder="Max $" value="@Model.MaxPrice" step="0.01" min="0">
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Apply Filters
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times me-1"></i>Clear All
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="col-lg-9 col-md-8">
            <!-- Results Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        @if (!string.IsNullOrEmpty(Model.Query))
                        {
                                <span>Search Results</span>
                        }
                        else
                        {
                                <span>All Products</span>
                        }
                    </h2>
                    <p class="text-muted mb-0">
                        @if (Model.TotalItems > 0)
                        {
                                <span>@Model.StartItem-@Model.EndItem of @Model.TotalItems products</span>
                            @if (Model.HasFilters)
                            {
                                        <span>for @Model.SearchSummary</span>
                            }
                        }
                        else
                        {
                                <span>No products found</span>
                        }
                    </p>
                </div>

                <!-- Sort Options -->
                @if (Model.Products.Any())
                {
                        <div class="d-flex align-items-center">
                            <label class="form-label me-2 mb-0">Sort by:</label>
                            <select name="sortBy" class="form-select form-select-sm" style="width: auto;" onchange="updateSort(this.value)">
                            @foreach (var option in Model.SortOptions)
                            {
                                        <option value="@option.Value" selected="@(Model.SortBy == option.Value)">
                                    @option.Text
                                        </option>
                            }
                            </select>
                        </div>
                }
            </div>

            <!-- Products Grid -->
            @if (Model.Products.Any())
            {
                    <div class="row">
                    @foreach (var product in Model.Products)
                    {
                                <div class="col-xl-4 col-lg-6 col-md-6 col-sm-6 mb-4">
                                    <div class="card h-100 shadow-sm product-card">
                                        <div class="position-relative">
                                            <img src="@product.ImageUrl" class="card-img-top" alt="@product.Name" 
                                                 style="height: 200px; object-fit: cover;">
                                    @if (product.Quantity <= 5 && product.Quantity > 0)
                                    {
                                                    <span class="badge bg-warning position-absolute top-0 end-0 m-2">Low Stock</span>
                                    }
                                    else if (product.Quantity == 0)
                                    {
                                                    <span class="badge bg-danger position-absolute top-0 end-0 m-2">Out of Stock</span>
                                    }
                                        </div>

                                        <div class="card-body d-flex flex-column">
                                            <div class="mb-2">
                                                <h6 class="card-title mb-1">@product.Name</h6>
                                                <small class="text-muted">@product.CategoryName</small>
                                            </div>

                                            <p class="card-text text-muted small flex-grow-1">
                                        @(product.Description.Length > 80 ? product.Description.Substring(0, 80) + "..." : product.Description)
                                            </p>

                                            <div class="mt-auto">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <span class="h5 text-primary mb-0">$@($"{product.Price:F2}")</span>
                                                    <small class="text-muted">@product.Quantity in stock</small>
                                                </div>

                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-primary btn-sm" onclick="addToCart(@product.ProductId)" 
                                            @(product.Quantity == 0 ? "disabled" : "")>
                                                        <i class="fas fa-shopping-cart me-1"></i>
                                                @(product.Quantity == 0 ? "Out of Stock" : "Add to Cart")
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    }
                    </div>

                    <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                            <nav aria-label="Search results pagination" class="mt-4">
                                <ul class="pagination justify-content-center">
                            @if (Model.HasPreviousPage)
                            {
                                            <li class="page-item">
                                                <a class="page-link" asp-action="Index" 
                                                   asp-route-query="@Model.Query" 
                                                   asp-route-categoryId="@Model.CategoryId"
                                                   asp-route-minPrice="@Model.MinPrice"
                                                   asp-route-maxPrice="@Model.MaxPrice"
                                                   asp-route-sortBy="@Model.SortBy"
                                                   asp-route-page="@(Model.CurrentPage - 1)">
                                                    <i class="fas fa-chevron-left"></i> Previous
                                                </a>
                                            </li>
                            }

                            @{
                                int startPage = Math.Max(1, Model.CurrentPage - 2);
                                int endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                            }

                            @if (startPage > 1)
                            {
                                            <li class="page-item">
                                                <a class="page-link" asp-action="Index" 
                                                   asp-route-query="@Model.Query" 
                                                   asp-route-categoryId="@Model.CategoryId"
                                                   asp-route-minPrice="@Model.MinPrice"
                                                   asp-route-maxPrice="@Model.MaxPrice"
                                                   asp-route-sortBy="@Model.SortBy"
                                                   asp-route-page="1">1</a>
                                            </li>
                                @if (startPage > 2)
                                {
                                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                            }

                            @for (int i = startPage; i <= endPage; i++)
                            {
                                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                                <a class="page-link" asp-action="Index" 
                                                   asp-route-query="@Model.Query" 
                                                   asp-route-categoryId="@Model.CategoryId"
                                                   asp-route-minPrice="@Model.MinPrice"
                                                   asp-route-maxPrice="@Model.MaxPrice"
                                                   asp-route-sortBy="@Model.SortBy"
                                                   asp-route-page="@i">@i</a>
                                            </li>
                            }

                            @if (endPage < Model.TotalPages)
                            {
                                @if (endPage < Model.TotalPages - 1)
                                {
                                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                }
                                            <li class="page-item">
                                                <a class="page-link" asp-action="Index" 
                                                   asp-route-query="@Model.Query" 
                                                   asp-route-categoryId="@Model.CategoryId"
                                                   asp-route-minPrice="@Model.MinPrice"
                                                   asp-route-maxPrice="@Model.MaxPrice"
                                                   asp-route-sortBy="@Model.SortBy"
                                                   asp-route-page="@Model.TotalPages">@Model.TotalPages</a>
                                            </li>
                            }

                            @if (Model.HasNextPage)
                            {
                                            <li class="page-item">
                                                <a class="page-link" asp-action="Index" 
                                                   asp-route-query="@Model.Query" 
                                                   asp-route-categoryId="@Model.CategoryId"
                                                   asp-route-minPrice="@Model.MinPrice"
                                                   asp-route-maxPrice="@Model.MaxPrice"
                                                   asp-route-sortBy="@Model.SortBy"
                                                   asp-route-page="@(Model.CurrentPage + 1)">
                                                    Next <i class="fas fa-chevron-right"></i>
                                                </a>
                                            </li>
                            }
                                </ul>
                            </nav>
                }
            }
            else
            {
                    <!-- No Results -->
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">No products found</h4>
                        <p class="text-muted mb-4">
                        @if (Model.HasFilters)
                        {
                                    <span>No products match your search criteria. Try adjusting your filters.</span>
                        }
                        else
                        {
                                    <span>No products are currently available.</span>
                        }
                        </p>
                        <div class="d-flex gap-2 justify-content-center">
                            <a asp-action="Index" class="btn btn-primary">
                                <i class="fas fa-refresh me-1"></i>View All Products
                            </a>
                            <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                                <i class="fas fa-home me-1"></i>Back to Home
                            </a>
                        </div>
                    </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function() {
        // Search suggestions
        let searchTimeout;

        $('#searchInput').on('input', function() {
            const query = $(this).val();
            clearTimeout(searchTimeout);

            if (query.length >= 2) {
                searchTimeout = setTimeout(function() {
                    $.ajax({
                        url: '@Url.Action("Suggestions", "Search")',
                        type: 'GET',
   

                        data: { query: query },
                        success: function(data) {
            

                            displaySuggestions(data);
                        }
                    });
                }, 300);
            } else {
                $('#searchSuggestions').hide();
            }
        });

        function displaySuggestions(suggestions) {
            const suggestionsDiv = $('#searchSuggestions');

            if (suggestions.length === 0) {
                suggestionsDiv.hide();
                return;
            }

            let html = '';
            suggestions.forEach(function(item) {
                html += `
                    <div class="suggestion-item" data-query="${item.name}">
                        <img src="${item.imageUrl}" alt="${item.name}" class="suggestion-image">
                        <div class="suggestion-content">
                            <div class="suggestion-name">${item.name}</div>
                            <div class="suggestion-category">${item.categoryName}</div>
                            <div class="suggestion-price">${item.price}</div>
                        </div>
                    </div>
                `;
            });

            suggestionsDiv.html(html).show();
        }

        // Handle suggestion clicks
        $(document).on('click', '.suggestion-item', function() {
            const query = $(this).data('query');
            $('#searchInput').val(query);
            $('#searchSuggestions').hide();
            $('#searchForm').submit();
        });

        // Hide suggestions when clicking outside
        $(document).click(function(e) {
            if (!$(e.target).closest('.position-relative').length) {
                $('#searchSuggestions').hide();
            }
        });
    });

    // Sort functionality
    function updateSort(sortValue) {
        const url = new URL(window.location);
        url.searchParams.set('sortBy', sortValue);
        url.searchParams.set('page', '1'); // Reset to first page
        window.location.href = url.toString();
    }

    // Add to cart functionality
    function addToCart(productId) {
        if (!@(Model.IsAuthenticated ? "true" : "false")) {
            window.location.href = '@Url.Action("Login", "Account")';
            return;
        }

        $.ajax({
            url: '@Url.Action("AddToCart", "Cart")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                productId: productId,
                quantity: 1
            }),
            success: function(response) {
                if (response.success) {
                    // Show success message
                    showNotification('Product added to cart!', 'success');
                    // Update cart count if element exists
                    if ($('#cartCount').length) {
                        $('#cartCount').text(response.cartCount);
                    }
                } else {
                    showNotification(response.message, 'error');
                    if (response.redirectToLogin) {
                        window.location.href = '@Url.Action("Login", "Account")';
                    }
                }
            },
            error: function() {
                showNotification('Error adding product to cart', 'error');
            }
        });
    }

    // Notification function
    function showNotification(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const notification = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('body').append(notification);

        // Auto-dismiss after 3 seconds
        setTimeout(function() {
            $('.alert').alert('close');
        }, 3000);
    }
    </script>

    <style>
    .product-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
    }

    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        border-radius: 0 0 4px 4px;
    }

    .suggestion-item {
        display: flex;
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        align-items: center;
        transition: background-color 0.2s;
    }

    .suggestion-item:hover {
        background-color: #f8f9fa;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-image {
        width: 40px;
        height: 40px;
        object-fit: cover;
        margin-right: 10px;
        border-radius: 4px;
    }

    .suggestion-content {
        flex: 1;
    }

    .suggestion-name {
        font-weight: 500;
        color: #333;
        font-size: 0.9rem;
    }

    .suggestion-category {
        font-size: 0.75rem;
        color: #666;
    }

    .suggestion-price {
        font-weight: 600;
        color: #007bff;
        font-size: 0.85rem;
    }

    /* Mobile responsiveness */
       @@media (max-width: 768px) {
        .container-fluid {
            padding: 0 15px;
        }

        .card-body {
            padding: 1rem;
        }

        .suggestion-item {
            padding: 8px;
        }

        .suggestion-image {
            width: 35px;
            height: 35px;
        }
    }
    </style>
}